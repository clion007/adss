# dnsmasq超强大的dnsmasq及hosts扶墙去广告全自动脚本

1、什么是Dnsmasq啊？（转自百度百科，不知道就百度）

DNSmasq是一个小巧且方便地用于配置DNS和DHCP的工具，适用于小型网络，它提供了DNS功能和可选择的DHCP功能。它服务那些只在本地适用的域名，这些域名是不会在全球的DNS服务器中出现的。DHCP服务器和DNS服务器结合，并且允许DHCP分配的地址能在DNS中正常解析，而这些DHCP分配的地址和相关命令可以配置到每台主机中，也可以配置到一台核心设备中（比如路由器），DNSmasq支持静态和动态两种DHCP配置方式。

2、Dnsmasq有什么用？能为我解决什么

默认的情况下，我们平时上网用的本地DNS服务器都是使用电信或者联通的，但是这样也导致了不少的问题，首当其冲的就是上网时经常莫名地弹出广告，或者莫名的流量被消耗掉导致网速变慢。其次是部分网站域名不能正常被解析，莫名其妙地打不开，或者时好时坏。
如果碰上不稳定的本地DNS，还可能经常出现无法解析的情况。除了要避免“坏”的DNS的影响，我们还可以利用DNS做些“好”事，例如管理局域网的DNS、给手机App Store加速、纠正错误的DNS解析记录、保证上网更加安全、去掉网页讨厌的广告等等。

3、方案dnsmasq提供了什么？

目前主要提供几个功能：
分域名DNS解析，提升加快不同网站的访问速度
国外域名加密解析自动扶墙，享受无墙的快感
屏蔽恶心的运营商ip劫持、全面屏蔽广告
屏蔽掉大部分广告的hosts

支持谷狗，优兔，非死不可等等熟悉的国外网站的访问规则来自gfwlist，优兔可以看1080p高清视频无压力，当然前提是你的带宽够用。

写本脚本的缘由：

之前使用adbyby之类的插件严重影响网速，因此才想进一步优化通过dnsmasq和hosts优化屏蔽广告，通过各种努力的查找，终于找到一些更加完善的广告过滤dnsmasq和hosts规则，并进一步优化dnsmasq配置和计划任务的命令行和参数，加入著名的adbyby和ABP插件用的easylistchina规则，加入国外网站广告过滤malwaredomainlist规则，加入手机端著名广告过滤软件adaway用的规则。除了个别视频广告外（PC可以通过浏览器插件屏蔽），基本通过浏览器插件及adbyby等插件能屏蔽的广告应该都能屏蔽了。为了方便小白都能容易上手，已将所有代码编辑为全自动的sh脚本，运行一次，所有事情都搞定了。本人亲测，并已经通过测试。

重要提示：兲朝上网请通过https加密连接访问！该脚本和方法只适用于Openwrt系列内核的固件，包括pandorabox。经网友测试证实，ddwrt系统可用。老毛子等其它固件可能不适用。如果不是相应的系统，小白就不用往下看了，以免浪费你宝贵的时间。如果是tomato、padavan等其它固件，可以参考http://www.right.com.cn/forum/forum.php?mod=viewthread&tid=184121帖子自行修改。

PS：如果以前运行过类似脚本或命令，不太清楚都改过什么地方，最好恢复出厂设置。
PS：因为有的固件携带的wget命令不支持https下载，需要重装wget。使用该脚本需要将dns设置为潘多拉lan网关（如192.168.1.1）

dnsmas_fqad.sh脚本运行方法：首次更改或路由器恢复出厂设置后，将下载得到的本脚本解压并通过winSCP上传到路由器/etc目录中，进入路由器的webshell或者电脑putty登录后运行命令：/bin/sh /etc/dnsmasq_fqad.sh。小白推荐用此方法，一键轻松搞定。

手动还原设置的方法：

打开/etc/dnsmasq.conf文件，删除如下内容：

all-servers
listen-address=192.168.1.1,127.0.0.1
resolv-file=/etc/dnsmasq/resolv.conf
addn-hosts=/etc/dnsmasq/noad.conf
bogus-priv
conf-file=/etc/dnsmasq.d/fqad.conf

删除/etc目录中dnsmasq以及dnsmasq.d文件夹

删除路由器设置中系统-计划任务中的代码。

至此，基本能完美的解决扶墙、DNS劫持以及各种广告的问题了。这种方法的弊端就是需要有人持续维护更新，如果发现有不能屏蔽的广告，欢迎大家到https://github.com/vokins/yhosts 反馈，作者更新后就可以屏蔽了。

据反馈，LEDE系列系统和Openwrt系列系统略有不同，请用LEDE专用脚本！

如果只是翻墙,不用屏蔽广告功能,请使用fq.sh全自动脚本。

特别感谢sy618、vokins提供的线上项目资源以及维护项目所做出的贡献！感谢lukme提供的脚本编译写法！感谢zshwq5提供的注入每日定时任务的代码！

# 免责声明

本项目所有重定向数据仅用于个人学术研究与学习使用。从未用于产生盈利行为（包括“捐赠”等方式）
未经许可，请勿内置于软件内发布与传播。请勿用于产生任何盈利活动。
仅供个人免费使用。请遵守当地法律法规，文明上网。

# 2017-6-11更新

修复之前已知的bug，重新写了4个不同的脚本文件：fqad.sh、fq.sh、fqad_auto.sh、fq_auto.sh，并实现更加人性化可视化选择安装和一键自动还原设置功能。不带auto的脚本运行时，需要输入设置lan IP等参数，带auto的脚本仅供路由器lan IP为192.168.1.1的网友使用。

# 2017.6.13更新优化

昨天修改增加墙外网站指定到443端口访问，希望可以借助ngnix反向代理，实现墙外网站的https安全链接自动跳转，结果出现了一些bug，现在已经对相关错误进行了修复，修复了之前脚本中，创建规则自动更新脚本输出错误的问题，修复了之前脚本中自动备份相关设置代码的问题，现在可以实现重新安装脚本时，自动备份原有配置，以便需要时运行脚本自动卸载恢复之前的配置。新脚本实现了墙外网站指定到443端口进行访问，并新增了单独的扶墙规则自动更新脚本，只是目前ngnix反向代理自动跳转还没有成功，如果有懂这一块的网友，欢迎联系我一起参与脚本的优化。谢谢！

# 2017.7.30更新优化

有网友反应sy618和racaljk地址有冲突导致部分网站访问问题，暂时修改为只使用sy618的扶墙规则。优化上游DNS解析服务器，优化视频及手机、电视APP广告过滤规则，加强了adaway规则的完善，增加4个规则更新源，更新后的规则文件有2M多点，是原来的十倍，更全面过滤各种广告。

此外，关于广告屏蔽导致有的网站被错杀无法打开的问题，请到https://github.com/vokins/yhosts 向规则维护者反馈。关于，墙外网站访问异常，可以到https://github.com/sy618/hosts 向作者反馈，一般用https访问不会有问题，如果确实遇到问题，只能等待作者更新规则，找到合适的IP。此类问题需要规则源中的规则更新才能解决，与本脚本无关，以后不再对此类问题做一一解答，请见谅，谢谢！
